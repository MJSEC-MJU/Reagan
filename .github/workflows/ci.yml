name: Docker Compose CI

on:
  push:
    branches:
      - dev
  pull_request:
    branches:
      - dev

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    # Compose 파일이 참조하는 환경변수
    env:
      DB_NAME:             ${{ secrets.DB_NAME }}
      DB_USERNAME:         ${{ secrets.DB_USERNAME }}
      DB_PASSWORD:         ${{ secrets.DB_PASSWORD }}
      DB_PORT:             3306
      DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Create Docker Compose .env
        run: |
          cat <<EOF > .env
          DB_NAME=${DB_NAME}
          DB_USERNAME=${DB_USERNAME}
          DB_PASSWORD=${DB_PASSWORD}
          DB_PORT=${DB_PORT}
          DOCKER_HUB_USERNAME=${DOCKER_HUB_USERNAME}
          EOF

      - name: Create SSL cert files for nginx
        run: |
          mkdir -p nginx/ssl
          echo "${{ secrets.SSL_CERT }}" > nginx/ssl/fullchain.pem
          echo "${{ secrets.SSL_KEY  }}" > nginx/ssl/privkey.pem
          ls -l nginx/ssl

      - name: Install Docker Compose
        run: |
          sudo apt-get update
          sudo apt-get install -y docker-compose

      - name: Build & start all services
        run: |
          docker-compose up --build -d

      - name: Wait for MySQL to be healthy
        run: |
          for i in {1..30}; do
            docker-compose exec -T db mysqladmin ping -h localhost --silent && break
            echo "Waiting for MySQL..."
            sleep 2
          done

      - name: Run Django tests
        run: docker-compose run --rm test

      - name: Collect backend logs (on success)
        if: success()
        run: docker-compose logs backend

      - name: Teardown all containers
        if: always()
        run: docker-compose down

      - name: Upload test report (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-report
          # BACK/reagan 폴더 내 테스트 리포트 경로로 조정하세요
          path: BACK/reagan/build/reports/tests/test
